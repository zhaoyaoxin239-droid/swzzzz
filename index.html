<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NS 游戏选购系统</title>
    <style>
        /* 页面整体风格：适配移动端 */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f4f4f7; color: #333; padding-bottom: 100px; }
        .header { background: #07c160; color: white; text-align: center; padding: 18px; font-size: 18px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* 统计卡片样式 */
        .stat-card { background: white; width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .stat-card td { border: 1px solid #f0f0f0; padding: 12px; font-size: 14px; width: 50%; }
        .label-red { color: #ff4d4f; font-weight: bold; }
        .label-green { color: #07c160; font-weight: bold; }
        
        /* 区块标题 */
        .section-header { padding: 15px; color: #666; font-size: 14px; background: #f4f4f7; font-weight: bold; }
        
        /* 选项列表 */
        .item-list { background: white; border-top: 1px solid #eee; }
        .item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f5f5f5; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .item:active { background: #fafafa; }
        .item input { width: 22px; height: 22px; margin-right: 12px; accent-color: #07c160; }
        .item-name { flex: 1; font-size: 15px; }
        
        /* 底部操作栏 */
        .footer-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding: 12px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); box-sizing: border-box; z-index: 99; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; margin: 0 6px; transition: opacity 0.2s; }
        .btn:active { opacity: 0.7; }
        .btn-primary { background: #07c160; color: white; }
        .btn-secondary { background: #f0f0f0; color: #666; }
        
        /* 弹窗样式 */
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; }
        .modal-inner { background:white; width:85%; margin:25% auto; padding:25px; border-radius:12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .input-text { width: 100%; padding: 14px; margin-top: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        .modal-title { margin: 0 0 15px 0; font-size: 18px; text-align: center; }
    </style>
</head>
<body>

<div class="header">NS 游戏自助选购清单</div>

<table class="stat-card">
    <tr><td>内存卡容量</td><td id="capText">900G</td></tr>
    <tr><td>已选容量</td><td id="usedText" class="label-red">0G</td></tr>
    <tr><td>已选数量</td><td id="countText">0</td></tr>
    <tr><td>剩余可用</td><td id="remainText" class="label-green">900G</td></tr>
</table>

<div class="section-header">1. 选择内存卡规格</div>
<div class="item-list">
    <label class="item"><input type="radio" name="card" value="900" checked onclick="updateCap(900)"> <span class="item-name">1024G (可用 900G)</span></label>
    <label class="item"><input type="radio" name="card" value="440" onclick="updateCap(440)"> <span class="item-name">512G (可用 440G)</span></label>
</div>

<div class="section-header">2. 必装基础插件</div>
<div class="item-list">
    <label class="item"><input type="checkbox" class="game-cb" data-n="虚拟系统空间" data-s="30" checked disabled> <span class="item-name">虚拟系统空间 (必选 30G)</span></label>
</div>

<div class="section-header">3. 勾选想玩的游戏</div>
<div class="item-list" id="gamesContainer">
    <label class="item"><input type="checkbox" class="game-cb" data-n="塞尔达传说:王国之泪" data-s="16.3"> <span class="item-name">塞尔达传说:王国之泪 (16.3G)</span></label>
    <label class="item"><input type="checkbox" class="game-cb" data-n="马里奥赛车8" data-s="7.5"> <span class="item-name">马里奥赛车8 (7.5G)</span></label>
    <label class="item"><input type="checkbox" class="game-cb" data-n="NBA 2K25" data-s="58"> <span class="item-name">NBA 2K25 (58G)</span></label>
    <label class="item"><input type="checkbox" class="game-cb" data-n="超级马里奥:惊奇" data-s="3.5"> <span class="item-name">超级马里奥:惊奇 (3.5G)</span></label>
    <label class="item"><input type="checkbox" class="game-cb" data-n="宝可梦:朱/紫" data-s="7.0"> <span class="item-name">宝可梦:朱/紫 (7.0G)</span></label>
</div>

<div class="footer-bar">
    <button class="btn btn-secondary" onclick="location.reload()">重置清空</button>
    <button class="btn btn-primary" onclick="openModal()">生成订单</button>
</div>

<div id="modal">
    <div class="modal-inner">
        <p class="modal-title">请填写联系信息</p >
        <input type="text" id="userName" class="input-text" placeholder="您的姓名/昵称">
        <input type="tel" id="userTel" class="input-text" placeholder="您的微信号/手机号">
        <button id="submitBtn" class="btn btn-primary" style="width:100%; margin-top:20px; margin-left:0" onclick="doSubmit()">确认发送到微信</button>
        <button class="btn btn-secondary" style="width:100%; margin-top:10px; margin-left:0" onclick="closeModal()">返回修改</button>
    </div>
</div>

<script>
    let currentCap = 900;

    // 更新容量逻辑
    function updateCap(v) {
        currentCap = v;
        calculate();
    }

    // 监听所有复选框点击
    document.addEventListener('change', (e) => {
        if(e.target.classList.contains('game-cb')) calculate();
    });

    // 计算容量
    function calculate() {
        let used = 0;
        let count = 0;
        document.querySelectorAll('.game-cb:checked').forEach(el => {
            used += parseFloat(el.dataset.s);
            count++;
        });
        
        document.getElementById('capText').innerText = currentCap + "G";
        document.getElementById('usedText').innerText = used.toFixed(2) + "G";
        document.getElementById('countText').innerText = count;
        
        let remain = currentCap - used;
        const remainEl = document.getElementById('remainText');
        remainEl.innerText = remain.toFixed(2) + "G";
        
        if(remain < 0) {
            remainEl.className = 'label-red';
            alert("⚠️ 空间不足！请取消部分游戏后再提交。");
        } else {
            remainEl.className = 'label-green';
        }
    }

    function openModal() { document.getElementById('modal').style.display = 'block'; }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    // 核心提交逻辑
    async function doSubmit() {
        const name = document.getElementById('userName').value.trim();
        const tel = document.getElementById('userTel').value.trim();
        const pushKey = "SCT312638Tq2VkkqahBM9xJDI2XhPN2Z45"; // 您的 PushDeer Key

        if(!name || !tel) {
            alert("请完整填写信息！");
            return;
        }

        let selected = [];
        document.querySelectorAll('.game-cb:checked').forEach(el => selected.push(el.dataset.n));

        const content = `【NS新订单】\n姓名：${name}\n联系：${tel}\n已选游戏：${selected.join('、')}\n总占空间：${document.getElementById('usedText').innerText}`;

        const btn = document.getElementById('submitBtn');
        btn.innerText = "正在发送...";
        btn.disabled = true;

        const apiUrl = `https://api2.pushdeer.com/message/push?pushkey=${pushKey}&text=${encodeURIComponent(content)}`;

        // 尝试方法 1: Fetch 后台请求
        try {
            const response = await fetch(apiUrl);
            const resData = await response.json();
            
            // 只要没有报错就认为成功
            alert("✅ 提交成功！请检查微信或 PushDeer APP 通知。");
            location.reload();
        } catch (error) {
            console.error("提交异常:", error);
            // 尝试方法 2: 如果 Fetch 失败（可能是跨域问题），改用直接跳转/新窗弹出
            if(confirm("后台发送受阻，是否尝试通过浏览器直接发送通知？")) {
                window.location.href = apiUrl;
            } else {
                btn.innerText = "重试提交";
                btn.disabled = false;
            }
        }
    }

    // 初始化计算一次
    window.onload = calculate;
</script>

</body>
</html>
